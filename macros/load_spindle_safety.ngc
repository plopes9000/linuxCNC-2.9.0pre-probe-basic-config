(author: Chris P)
(version: 0.2)
(date: 03/10/20)

(load tool in spindle safety macro)

o<load_spindle_safety> sub

#<load_spindle_tool_number> = #1
#<activate_programmable_coolant> = #2
#<horizontal_spindle_nozzle_dist> = #3
#<vertical_spindle_nozzle_dist> = #4
#<pc_angle_offset> = #5

#<left_positions> = [#<_ini[atc]left_pockets>]    ; left atc pockets
#<right_positions>= [#<_ini[atc]right_pockets>]    ; right atc pockets
#<my_tool_in_spindle>            = [#<_ini[atc]var_tool_in_spindle>]           ; relies on eg. 4090 to be manually created in linuxcnc.var file
#<my_tool_in_spindle_atc_bound>  = [#<_ini[atc]var_tool_in_spindle_atc_bound>] ; relies on eg. 4091 to be manually created in linuxcnc.var file
#<toolstart>                     = [#<_ini[atc]var_tools_start>] ; relies on eg. 4902-4938, #<left_positions> + #<right_positions> to be manually created in linuxcnc.var file

; aux vars
#<pick_up_pocket> = 0 ; assigns 0 to the pick up pocket for a later check if the tool is found in the carousel

; look for an empty pocket and desired tool pocket
#<loop_idx>=[#<left_positions>+#<right_positions>]
o20 while [ #<loop_idx> gt 0 ]
  o21 if [ #[#<toolstart>+#<loop_idx>-1] eq #<load_spindle_tool_number> ] ; checks all pockets to see if it contains tool number requested
    (debug, the tool you are trying to load is already stored in carousel pocket #<loop_idx>)
    o<load_spindle_safety> return
  o21 endif
  #<loop_idx>=[#<loop_idx>-1]
o20 endwhile

#[#<my_tool_in_spindle>] = #<load_spindle_tool_number>  ;Set persistent variable to remember tool in spindle after power cycle
#[#<my_tool_in_spindle_atc_bound>] = 0 ; set spindle tool manual flag to false
M61 Q#<load_spindle_tool_number> G43 H#<load_spindle_tool_number>


#<pc_tool_length> = #5403

(run program_coolant sub if selected to be active in settings page with value 1)
o<110> if [#<activate_programmable_coolant> EQ 1]
  (run program_coolant.ngc)
  o<program_coolant> call [#3][#4][#5][#<pc_tool_length>]
o<110> else
  o<load_spindle_safety> return
o<110> endif

o<load_spindle_safety> endsub

M2 (end program)
