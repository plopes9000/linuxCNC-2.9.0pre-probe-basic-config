O<tool-setter> sub (measure tool with TS27R)
#<tool_number>=#1 (tool number)
#<tool_xy_diam>=#2 (~ XY plane tool diam, precise for ref tool, zero for no diam meas)
#<tool_z_diam>=#3 (=0 ~ Z plane tool diam, zero for same as XY plane -> single point and inserts)
#<tool_length>=#4 (~ tool length)
#<tool_rotate>=#5 (=1 rotate tool, ingored for ref tool)
#<update_tooltable>=#6 (=1 update tooltable)
#<ref_tool>=#7 (=0 reference tool)

(info: TS27r Toolsetter TLO)

;;;;;;;;;;;;;;;;;;;;;;
;; ini file params
;;
;; [TOOLSETTER]
;; X= tool setter G53 X
;; Y= tool setter G53 Y
;; Z= tool setter G53 Z
;; TOOLSETTER_DIAM=12.7
;; TOOLSETTER_HEIGHT=14
;; BACKOFF=1
;; Z_CLEARANCE=2
;; SAFE_HEIGHT=50
;; RAPID_FEED=1500
;; COARSE_FEED=500
;; COARSE_RPM=750
;; FINE_RPM=1500
;; PRECISION=0.005 # to calculate fine feed: feed (mm/min/rot) = precision * spindle rpm
;;;;;;;;;;;;;;;;;;;;;;
;; Global Vars - need to be manually added to linuxcnc.var once
;; 601 - reference tool position G53 Z
;; 602 - measured tool setter diameter
;;;;;;;;;;;;;;;;;;;;;;



o05 if [#<ref_tool> NE 1]
  o07 if [#601 EQ 0]
    (debug,reference tool z pos not set, please run cycle for ref tool)
    m2 (stop program)
  o07 endif
  
  o06 if [#602 EQ 0]
    (debug,tool setter diam not measured, please run cycle for ref tool)
    m2 (stop program)
  o06 endif
o05 else
  o51 if [#<tool_xy_diam> EQ 0]
    (debug,for measuring ref tool, please enter the ref tool precise diameter)
    m2 (stop program)
  o51 endif
o05 endif


;; preamble
g21 g17 g40 g80 g94 g90 g49 g92.1


;; load tool
T#<tool_number> M6

;;activate tool setter
M64 P0 

;;fetch ini params
#<tool_setter_x>=#<_ini[TOOLSETTER]X>
#<tool_setter_y>=#<_ini[TOOLSETTER]Y>
#<tool_setter_z>=#<_ini[TOOLSETTER]Z>
#<rapid_feed>=#<_ini[TOOLSETTER]RAPID_FEED>
#<coarse_feed>=#<_ini[TOOLSETTER]COARSE_FEED>
#<fine_rpm>=#<_ini[TOOLSETTER]FINE_RPM>
#<fine_feed>=[#<_ini[TOOLSETTER]PRECISION>*#<fine_rpm>*0.9]
#<coarse_rpm>=#<_ini[TOOLSETTER]COARSE_RPM>
#<probe_backoff>=#<_ini[TOOLSETTER]BACKOFF>
#<z_clearance>=#<_ini[TOOLSETTER]Z_CLEARANCE>
#<toolsetter_diam>=#<_ini[TOOLSETTER]TOOLSETTER_DIAM>
#<toolsetter_height>=#<_ini[TOOLSETTER]TOOLSETTER_HEIGHT>
#<safe_height>=#<_ini[TOOLSETTER]SAFE_HEIGHT>

;; calculate fine feed for requested precision 
o23 if [#<fine_feed> LE 1]
  #<fine_feed>=5
  (debug, calc. fine feed too small, suing #<fine_feed> mach units/min)
o23 else
  (debug, calc. fine feed=#<fine_feed> mach units/min)
o23 end if

g54 ; to be able to use #5221,2,3


;; ref tool cycle
o09 if [#<ref_tool> EQ 1]
  (measure reference tool - WITHOUT ROTATION)
  (position above toolsetter)
  g53 g0 z0
  g53 g0 X#<tool_setter_x> Y#<tool_setter_y>
  o<p-move> call [#<_x>] [#<_y>] [#<tool_setter_z>+#<safe_height>+#<tool_length>-#5223] [0] [#<rapid_feed>]

  
  (ensure tool is aligned with tollsetter center line on X)
  g91 g38.2 z[-#<safe_height>-5] f#<coarse_feed> (coarse measure)
  g91 g1 z#<probe_backoff> f#<rapid_feed> (backoff)
  g91 g38.2 z[-#<probe_backoff>-1] f#<fine_feed> (fine measure)
  g28.1
  #601=[#5163] (save reference tool pos)
  (debug,measured ref length # 601 = #601)
  o21 if [ #<update_tooltable> EQ 1 ]
    G10 L1 P#<tool_number> Z0 ; tool reference is 0 length offset
    (debug,tooltable Z updated)
  o21 else
    (debug,tooltable not updated)
  o21 endif
  g91 g1 z#<z_clearance> f#<rapid_feed> (backoff)
  o<p-move> call [#<tool_setter_x>-#5221] [#<tool_setter_y>-#5222] [#<_z>] [0] [#<rapid_feed>]
  
  ( y+ measure )
  o<p-move> call [0] [-#<tool_xy_diam>/2*1.5-#<toolsetter_diam>/2] [0] [1] [#<rapid_feed>]
  o<p-move> call [0] [0] [-#<z_clearance>-#<toolsetter_height>/2] [1] [#<rapid_feed>]
  g91 g38.2 y[#<tool_xy_diam>/2*1.7] f#<coarse_feed> (coarse measure)
  g91 g1 y-#<probe_backoff> f#<rapid_feed> (backoff)
  g91 g38.2 y[#<probe_backoff>*1.2] f#<fine_feed> (fine measure)
  #1002=#5062 (save +y measure)
  g91 g1 y-#<probe_backoff> f#<rapid_feed> (backoff)
  o<p-move> call [0] [0] [#<z_clearance>+#<toolsetter_height>/2] [1] [#<rapid_feed>]
  o<p-move> call [0] [#<probe_backoff>] [0] [1] [#<rapid_feed>]
  o<p-move> call [#<tool_setter_x>-#5221] [#<tool_setter_y>-#5222] [#<_z>] [0] [#<rapid_feed>]
  
  
  ( y- measure )
  o<p-move> call [0] [#<tool_xy_diam>/2*1.5+#<toolsetter_diam>/2] [0] [1] [#<rapid_feed>]
  o<p-move> call [0] [0] [-#<z_clearance>-#<toolsetter_height>/2] [1] [#<rapid_feed>]
  g91 g38.2 y[-#<tool_xy_diam>/2*1.7] f#<coarse_feed> (coarse measure)
  g91 g1 y#<probe_backoff> f#<rapid_feed> (backoff)
  g91 g38.2 y[-#<probe_backoff>*1.2] f#<fine_feed> (fine measure)
  #1003=#5062 (save -y measure)
  g91 g1 y#<probe_backoff> f#<rapid_feed> (backoff)
  o<p-move> call [0] [0] [#<z_clearance>+#<toolsetter_height>/2] [1] [#<rapid_feed>]
  o<p-move> call [0] [-#<probe_backoff>] [0] [1] [#<rapid_feed>]
  o<p-move> call [#<tool_setter_x>-#5221] [#<tool_setter_y>-#5222] [#<_z>] [0] [#<rapid_feed>]
  M5 (stop spindle)
 
  (calculate tool setter measured diameter)  
  #602=[#1003-#1002-#<tool_xy_diam>]
  (debug, tool setter measured diam # 602 = #602)

o09 else

  (measure tool length)

  o121 if [#<tool_z_diam> EQ 0]
    #<tool_z_diam>=#<tool_xy_diam>
  o121 end if
  
  ;; fetch global vars
  #<ref_tool_z>=#601
  #<toolsetter_diam>=#602

 
  (position above toolsetter)
  g53 g0 z0
  g53 g0 X[#<tool_setter_x>+#<tool_z_diam>/2] Y#<tool_setter_y> 
  o<p-move> call [#<_x>] [#<_y>] [#<tool_setter_z>+#<safe_height>+#<tool_length>-#5223] [0] [#<rapid_feed>]

  o115 if [#<tool_rotate> EQ 1] 
    S#<coarse_rpm> M4 (start spindle in reverse)
  o115 endif
  g91 g38.2 z[-#<safe_height>-5] f#<coarse_feed> (coarse measure)
  g91 g1 z#<probe_backoff> f#<rapid_feed> (backoff)
  o116 if [#<tool_rotate> EQ 1] 
    S#<fine_rpm> M4 (start spindle in reverse)
  o116 endif
  g91 g38.2 z[-#<probe_backoff>-1] f#<fine_feed> (fine measure)
  g28.1
  #1005=[#5163-#<ref_tool_z>]
  (debug,tool length offset: #1005)
  o11 if [ #<update_tooltable> EQ 1 ]
    G10 L1 P#<tool_number> Z#1005
    (debug,tooltable Z updated)
  o11 else
    (debug,tooltable not updated)
  o11 endif
  g91 g1 z#<z_clearance> f#<rapid_feed> (backoff)
  o<p-move> call [#<tool_setter_x>-#5221] [#<tool_setter_y>-#5222] [#<_z>] [0] [#<rapid_feed>]
  o117 if [#<tool_rotate> EQ 1] 
    S#<coarse_rpm> M4 (start spindle in reverse)
  o117 endif
  
  o118 if [#<tool_xy_diam> NE 0]
    ( y+ measure )
    o<p-move> call [0] [-#<tool_xy_diam>/2*1.5-#<toolsetter_diam>/2] [0] [1] [#<rapid_feed>]
    o<p-move> call [0] [0] [-#<z_clearance>-#<toolsetter_height>/2] [1] [#<rapid_feed>]
    g91 g38.2 y[#<tool_xy_diam>/2*1.7] f#<coarse_feed> (coarse measure)
    g91 g1 y-#<probe_backoff> f#<rapid_feed> (backoff)
    o122 if [#<tool_rotate> EQ 1] 
      S#<fine_rpm> M4 (start spindle in reverse)
    o122 endif
    g91 g38.2 y[#<probe_backoff>*1.2] f#<fine_feed> (fine measure)
    #1002=#5062 (save +y measure)
    g91 g1 y-#<probe_backoff> f#<rapid_feed> (backoff)
    o<p-move> call [0] [0] [#<z_clearance>+#<toolsetter_height>/2] [1] [#<rapid_feed>]
    o<p-move> call [0] [#<probe_backoff>] [0] [1] [#<rapid_feed>]
    o<p-move> call [#<tool_setter_x>-#5221] [#<tool_setter_y>-#5222] [#<_z>] [0] [#<rapid_feed>]
    o119 if [#<tool_rotate> EQ 1] 
      S#<coarse_rpm> M4 (start spindle in reverse)
    o119 endif
   
    (y- measure) 
    o<p-move> call [0] [#<tool_xy_diam>/2*1.5+#<toolsetter_diam>/2] [0] [1] [#<rapid_feed>]
    o<p-move> call [0] [0] [-#<z_clearance>-#<toolsetter_height>/2] [1] [#<rapid_feed>]
    g91 g38.2 y[-#<tool_xy_diam>/2*1.7] f#<coarse_feed> (coarse measure)
    g91 g1 y#<probe_backoff> f#<rapid_feed> (backoff)
    o120 if [#<tool_rotate> EQ 1] 
      S#<fine_rpm> M4 (start spindle in reverse)
    o120 endif
    g91 g38.2 y[-#<probe_backoff>*1.2] f#<fine_feed> (fine measure)
    #1003=#5062 (save -y measure)
    g91 g1 y#<probe_backoff> f#<rapid_feed> (backoff)
    o<p-move> call [0] [0] [#<z_clearance>+#<toolsetter_height>/2] [1] [#<rapid_feed>]
    o<p-move> call [0] [-#<probe_backoff>] [0] [1] [#<rapid_feed>]
    o<p-move> call [#<tool_setter_x>-#5221] [#<tool_setter_y>-#5222] [#<_z>] [0] [#<rapid_feed>]
    M5 (stop spindle)
    
    #1005=[#1003-#1002-#602]
    (debug, measured tool diameter #1005)
 
    o12 if [ #<update_tooltable> EQ 1 ]
      G10 L1 P#<tool_number> R[#1005/2]
      (debug,tooltable D updated)
    o12 endif
    
  o118 end if
o09 end if

g90 (absolute distance mode)
M65 P0 (activate 3d probe)


O<tool-setter> endsub 


